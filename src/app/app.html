<div *ngIf="headers.length > 0" class="table-container" [class.full-height]="!isDropZoneVisible">
  <table>
    <thead>
      <tr>
        <th *ngFor="let header of headers; let i = index" [style.display]="columnVisibility[i] ? '' : 'none'">
          <div class="header-content">
            <span (click)="sortData(i)">
              {{ header }}
              <ng-container *ngIf="sortColumnIndex === i && sortDirection">
                {{ sortDirection === 'asc' ? 'â–²' : 'â–¼' }}
              </ng-container>
            </span>
            <button class="stats-button" *ngIf="columnStats[i]?.isNumeric" (click)="toggleStatsPanel(i)">ðŸ“Š</button>
          </div>
        </th>
      </tr>
      <tr class="filter-row">
        <th *ngFor="let header of headers; let i = index" [style.display]="columnVisibility[i] ? '' : 'none'">
          <input type="text" [(ngModel)]="filterTexts[i]" (ngModelChange)="applyFiltersAndSort()"
            placeholder="Filter...">
        </th>
      </tr>
      <tr *ngIf="statsVisibleColumnIndex !== null" class="stats-row">
          <th *ngFor="let header of headers; let i = index" [style.display]="columnVisibility[i] ? '' : 'none'">
            <div *ngIf="statsVisibleColumnIndex === i && columnStats[i] as stats" class="stats-panel">
              <div><span class="stat-label">Count:</span> <span class="stat-value">{{ stats.count }}</span></div>
              <div><span class="stat-label">Min:</span> <span class="stat-value">{{ stats.min.toFixed(2) }}</span></div>
              <div><span class="stat-label">Max:</span> <span class="stat-value">{{ stats.max.toFixed(2) }}</span></div>
              <div><span class="stat-label">Avg:</span> <span class="stat-value">{{ stats.avg.toFixed(2) }}</span></div>
              <div><span class="stat-label">Nulls:</span> <span class="stat-value">{{ stats.nulls }}</span></div>
            </div>
          </th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of paginatedRows">
        <td *ngFor="let cell of row; let i = index" [style.display]="columnVisibility[i] ? '' : 'none'">{{ cell }}</td>
      </tr>
      <tr *ngIf="paginatedRows.length === 0 && hasAnyFilter()">
        <td [attr.colspan]="headers.length" class="no-results">No matching records found.</td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="headers.length > 0" class="bottom-controls">
  <div class="input-controls">
    <button (click)="toggleDropZone()">
      {{ isDropZoneVisible ? 'Hide Input' : 'Show Input' }}
    </button>
    <div *ngIf="headers.length > 0" class="column-visibility-controls" style="margin-left: 16px;">
      <label *ngFor="let header of headers; let i = index">
        <input type="checkbox" [(ngModel)]="columnVisibility[i]">
        {{ header }}
      </label>
    </div>
  </div>

  <div *ngIf="filteredRows.length > 0" class="pagination-controls">
    <button (click)="clearAllFilters()" *ngIf="hasAnyFilter()">Clear All Filters</button>

    <select (change)="onItemsPerPageChange($event)">
      <option value="10" selected>10 per page</option>
      <option value="20">20 per page</option>
      <option value="50">50 per page</option>
      <option value="100">100 per page</option>
      <option value="0">Show All</option>
    </select>

    <button (click)="goToFirstPage()" [disabled]="currentPage === 1">First</button>
    <button (click)="previousPage()" [disabled]="currentPage === 1">Previous</button>
    <span>Page {{ currentPage }} of {{ getTotalPages() }}</span>
    <button (click)="nextPage()" [disabled]="currentPage >= getTotalPages()">Next</button>
    <button (click)="goToLastPage()" [disabled]="currentPage >= getTotalPages()">Last</button>
  </div>
</div>

<div class="input-container">
  <textarea *ngIf="isDropZoneVisible" class="drop-zone"
    (dragover)="onDragOver($event)"
    (drop)="onDrop($event)"
    (dragenter)="onDragEnter($event)"
    (dragleave)="onDragLeave($event)"
    (change)="processCsvData(csvInput)"
    [(ngModel)]="csvInput"
    [class.drag-over]="isDragging"
    placeholder="Drop CSV or Parquet file here, or paste CSV content and click outside the box to process.">
  </textarea>
</div>
